version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    ports:
      - "${BACKEND_PORT:-8005}:${BACKEND_PORT:-8005}"
    environment:
      - BACKEND_PORT=${BACKEND_PORT:-8005}
      - PYTHONPATH=/app
      - DEBUG=${DEBUG:-false}
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      # Intervals.icu
      - INTERVALS_API_KEY=${INTERVALS_API_KEY}
      - ATHLETE_ID=${ATHLETE_ID}
      # LLM
      - LLM_PROVIDER=${LLM_PROVIDER:-groq}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GROQ_MODEL=${GROQ_MODEL:-llama-3.3-70b-versatile}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Security
      - ADMIN_SECRET=${ADMIN_SECRET}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_EXPIRATION_HOURS=${JWT_EXPIRATION_HOURS:-24}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      # Hot reload: mount source code
      - ./api:/app/api:ro
      - ./src:/app/src:ro
    networks:
      - app-network
    # Allow external network access (for Supabase)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "${FRONTEND_PORT:-3005}:${FRONTEND_PORT:-3005}"
    environment:
      - VITE_API_URL=http://localhost:${BACKEND_PORT:-8005}
      - VITE_SUPABASE_URL=${SUPABASE_URL}
      - VITE_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
    volumes:
      # Hot reload: mount source code
      - ./frontend/src:/app/src:ro
      - ./frontend/public:/app/public:ro
    networks:
      - app-network
    depends_on:
      - backend
    restart: unless-stopped

networks:
  app-network:
    driver: bridge
